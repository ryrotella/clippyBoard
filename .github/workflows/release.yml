name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

env:
  SCHEME: ClippyBoard
  PROJECT_PATH: ClipBoard/ClippyBoard/ClippyBoard.xcodeproj

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$MACOS_CERTIFICATE_PWD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain

      - name: Build and archive
        run: |
          xcodebuild -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath $RUNNER_TEMP/ClippyBoard.xcarchive \
            -destination "generic/platform=macOS" \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_IDENTITY="${{ secrets.MACOS_CERTIFICATE_NAME }}" \
            archive

      - name: Export app
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/ClippyBoard.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $RUNNER_TEMP/export

      - name: Create DMG
        run: |
          brew install create-dmg

          # Create DMG with nice layout
          create-dmg \
            --volname "ClippyBoard" \
            --volicon "$RUNNER_TEMP/export/ClippyBoard.app/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "ClippyBoard.app" 150 185 \
            --hide-extension "ClippyBoard.app" \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg" \
            "$RUNNER_TEMP/export/ClippyBoard.app" || true

          # Fallback if create-dmg fails
          if [ ! -f "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg" ]; then
            hdiutil create -volname "ClippyBoard" \
              -srcfolder "$RUNNER_TEMP/export/ClippyBoard.app" \
              -ov -format UDZO \
              "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg"
          fi

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PWD: ${{ secrets.APPLE_ID_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit for notarization
          xcrun notarytool submit "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PWD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg"

      - name: Verify notarization
        run: |
          spctl -a -vvv -t install "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg"

      - name: Calculate SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg" | awk '{print $1}')
          echo "SHA256=$SHA" >> $GITHUB_OUTPUT
          echo "$SHA  ClippyBoard-${{ steps.version.outputs.TAG }}.dmg" > "$RUNNER_TEMP/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg.sha256"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ClippyBoard ${{ steps.version.outputs.TAG }}
          draft: false
          prerelease: false
          files: |
            ${{ runner.temp }}/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg
            ${{ runner.temp }}/ClippyBoard-${{ steps.version.outputs.TAG }}.dmg.sha256
          body: |
            ## ClippyBoard ${{ steps.version.outputs.TAG }}

            ### Installation

            **Homebrew (recommended):**
            ```bash
            brew tap ryrotella/clippyboard
            brew install --cask clippyboard
            ```

            **Manual:**
            1. Download `ClippyBoard-${{ steps.version.outputs.TAG }}.dmg`
            2. Open and drag ClippyBoard to Applications

            ### Checksums

            **SHA256:** `${{ steps.sha.outputs.SHA256 }}`

            ---

            See [RELEASE_NOTES](https://github.com/ryrotella/clippyBoard/blob/main/docs/RELEASE_NOTES_v1.0.0.md) for full changelog.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output Homebrew cask update
        run: |
          echo "::notice::Update your Homebrew cask with:"
          echo "version \"${{ steps.version.outputs.VERSION }}\""
          echo "sha256 \"${{ steps.sha.outputs.SHA256 }}\""
